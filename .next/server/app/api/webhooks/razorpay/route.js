"use strict";(()=>{var e={};e.id=875,e.ids=[875],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},5978:(e,a,t)=>{t.r(a),t.d(a,{headerHooks:()=>I,originalPathname:()=>k,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>g,staticGenerationAsyncStorage:()=>b,staticGenerationBailout:()=>R});var r={};t.r(r),t.d(r,{POST:()=>l});var o=t(95419),i=t(69108),n=t(99678),s=t(78070),d=t(6113),u=t.n(d),c=t(34490);async function l(e){try{let a=await e.text(),t=e.headers.get("x-razorpay-signature");if(!t)return s.Z.json({error:"Missing signature"},{status:400});let r=process.env.RAZORPAY_WEBHOOK_SECRET;if(!r)return console.error("Razorpay webhook secret not configured"),s.Z.json({error:"Webhook not configured"},{status:500});let o=u().createHmac("sha256",r).update(a).digest("hex");if(t!==o)return await c.Z.webhookLog.create({data:{provider:"RAZORPAY",event:"SIGNATURE_FAILED",payload:{body:a.substring(0,500)},status:"FAILED"}}),s.Z.json({error:"Invalid signature"},{status:400});let i=JSON.parse(a),n=await c.Z.webhookLog.create({data:{provider:"RAZORPAY",event:i.event,payload:i,status:"PENDING"}});try{switch(i.event){case"payment.captured":await p(i.payload.payment.entity);break;case"payment.failed":await w(i.payload.payment.entity);break;case"refund.created":await y(i.payload.refund.entity);break;case"order.paid":await m(i.payload.order.entity);break;default:console.log("Unhandled event:",i.event)}await c.Z.webhookLog.update({where:{id:n.id},data:{status:"SUCCESS"}})}catch(e){console.error("Webhook processing error:",e),await c.Z.webhookLog.update({where:{id:n.id},data:{status:"FAILED",error:e instanceof Error?e.message:"Unknown error"}})}return s.Z.json({received:!0})}catch(e){return console.error("Razorpay webhook error:",e),s.Z.json({error:"Webhook processing failed"},{status:500})}}async function p(e){let{order_id:a,id:t,amount:r,notes:o}=e,i=o?.orderId;i&&await c.Z.$transaction(async e=>{let a=await e.order.update({where:{id:i},data:{paymentStatus:"PAID",paymentId:t,status:"CONFIRMED"}});await e.orderTimeline.create({data:{orderId:i,status:"CONFIRMED",title:"Payment Successful",description:`Payment of ₹${r/100} received`}}),await e.notification.create({data:{userId:a.userId,type:"ORDER",title:"Payment Successful",message:`Your payment of ₹${r/100} for order #${a.orderNumber} was successful.`,data:{orderId:i}}})});let n=o?.walletUserId;n&&await c.Z.$transaction(async e=>{let a=await e.wallet.findUnique({where:{userId:n}});a&&(await e.wallet.update({where:{userId:n},data:{balance:{increment:r/100}}}),await e.walletTransaction.create({data:{walletId:a.id,type:"CREDIT",amount:r/100,description:"Added money via Razorpay",referenceId:t}}),await e.notification.create({data:{userId:n,type:"WALLET",title:"Money Added",message:`₹${r/100} has been added to your wallet.`,data:{paymentId:t}}}))})}async function w(e){let{notes:a,error_description:t}=e,r=a?.orderId;r&&await c.Z.$transaction(async e=>{let a=await e.order.update({where:{id:r},data:{paymentStatus:"FAILED"}});await e.orderTimeline.create({data:{orderId:r,status:"PENDING",title:"Payment Failed",description:t||"Payment could not be processed"}}),await e.notification.create({data:{userId:a.userId,type:"ORDER",title:"Payment Failed",message:`Payment for order #${a.orderNumber} failed. Please try again.`,data:{orderId:r}}})})}async function y(e){let{payment_id:a,amount:t,notes:r}=e,o=r?.orderId;o&&await c.Z.$transaction(async e=>{let a=await e.order.findUnique({where:{id:o}});a&&(await e.order.update({where:{id:o},data:{paymentStatus:"REFUNDED"}}),await e.orderTimeline.create({data:{orderId:o,status:a.status,title:"Refund Initiated",description:`Refund of ₹${t/100} initiated`}}),await e.notification.create({data:{userId:a.userId,type:"ORDER",title:"Refund Initiated",message:`Refund of ₹${t/100} for order #${a.orderNumber} has been initiated.`,data:{orderId:o}}}))})}async function m(e){console.log("Order paid:",e.id)}let f=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/webhooks/razorpay/route",pathname:"/api/webhooks/razorpay",filename:"route",bundlePath:"app/api/webhooks/razorpay/route"},resolvedPagePath:"C:\\Users\\basan\\Desktop\\karim123\\KarimTraders\\src\\app\\api\\webhooks\\razorpay\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:b,serverHooks:g,headerHooks:I,staticGenerationBailout:R}=f,k="/api/webhooks/razorpay/route";function v(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:b})}},34490:(e,a,t)=>{t.d(a,{Z:()=>i,_:()=>o});var r=t(53524);let o=globalThis.prisma??new r.PrismaClient({log:["error"]}),i=o}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),r=a.X(0,[1638,6206],()=>t(5978));module.exports=r})();