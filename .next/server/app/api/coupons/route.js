"use strict";(()=>{var e={};e.id=2475,e.ids=[2475],e.modules={53524:e=>{e.exports=require("@prisma/client")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},25727:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>h,originalPathname:()=>g,patchFetch:()=>w,requestAsyncStorage:()=>l,routeModule:()=>p,serverHooks:()=>v,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var o={};t.r(o),t.d(o,{GET:()=>d,POST:()=>c});var n=t(95419),a=t(69108),i=t(99678),u=t(78070),s=t(34490);async function c(e){try{let{code:r,subtotal:t}=await e.json();if(!r)return u.Z.json({error:"Coupon code required"},{status:400});let o=await s.Z.coupon.findFirst({where:{code:r.toUpperCase(),isActive:!0,validFrom:{lte:new Date},validUntil:{gte:new Date}}});if(!o)return u.Z.json({error:"Invalid or expired coupon"},{status:400});if(o.usageLimit&&o.usedCount>=o.usageLimit)return u.Z.json({error:"Coupon usage limit exceeded"},{status:400});if(o.minOrderAmount&&t<Number(o.minOrderAmount))return u.Z.json({error:`Minimum order amount is â‚¹${o.minOrderAmount}`},{status:400});let n=0;return"PERCENTAGE"===o.type?(n=t*Number(o.value)/100,o.maxDiscount&&(n=Math.min(n,Number(o.maxDiscount)))):n=Number(o.value),u.Z.json({valid:!0,coupon:{code:o.code,type:o.type,value:o.value,description:o.description},discount:Math.round(100*n)/100})}catch(e){return console.error("Coupon validation error:",e),u.Z.json({error:"Failed to validate coupon"},{status:500})}}async function d(e){try{let e=await s.Z.coupon.findMany({where:{isActive:!0,validFrom:{lte:new Date},validUntil:{gte:new Date}},select:{code:!0,type:!0,value:!0,description:!0,minOrderAmount:!0,maxDiscount:!0,validUntil:!0},orderBy:{validUntil:"asc"}});return u.Z.json(e)}catch(e){return console.error("Coupons fetch error:",e),u.Z.json({error:"Failed to fetch coupons"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/coupons/route",pathname:"/api/coupons",filename:"route",bundlePath:"app/api/coupons/route"},resolvedPagePath:"c:\\Users\\basan\\Desktop\\karim123\\KarimTraders\\src\\app\\api\\coupons\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:v,headerHooks:h,staticGenerationBailout:f}=p,g="/api/coupons/route";function w(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:m})}},34490:(e,r,t)=>{t.d(r,{Z:()=>a,_:()=>n});var o=t(53524);let n=globalThis.prisma??new o.PrismaClient({log:["error"]}),a=n}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[1638,6206],()=>t(25727));module.exports=o})();