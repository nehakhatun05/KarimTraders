"use strict";(()=>{var e={};e.id=7031,e.ids=[7031],e.modules={99344:e=>{e.exports=require("jsonwebtoken")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},29505:e=>{e.exports=import("socket.io")},56249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},44587:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>c,routeModule:()=>u});var o=r(71802),i=r(47153),a=r(56249),s=r(66265),d=e([s]);s=(d.then?(await d)():d)[0];let c=(0,a.l)(s,"default"),l=(0,a.l)(s,"config"),u=new o.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/socket",pathname:"/api/socket",bundlePath:"",filename:""},userland:s});n()}catch(e){n(e)}})},33339:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.d(t,{DB:()=>d});var o=r(29505),i=r(99344),a=r.n(i),s=e([o]);o=(s.then?(await s)():s)[0];let c=new Map;function d(e){if(e.io)return console.log("Socket.io already initialized"),e.io;let t=new o.Server(e,{path:"/api/socket",addTrailingSlash:!1,cors:{origin:process.env.NEXTAUTH_URL||"http://localhost:3000",methods:["GET","POST"],credentials:!0}});return t.use(async(e,t)=>{try{let r=e.handshake.auth.token||e.handshake.headers.authorization?.split(" ")[1];if(!r)return t(Error("Authentication required"));let n=a().verify(r,process.env.NEXTAUTH_SECRET);e.data.user=n,t()}catch(e){t(Error("Invalid token"))}}),t.on("connection",e=>{let r=e.data.user;console.log(`User connected: ${r.userId}`);let n=c.get(r.userId)||[];n.push(e.id),c.set(r.userId,n),e.join(`user:${r.userId}`),("ADMIN"===r.role||"SUPER_ADMIN"===r.role)&&e.join("admin"),e.on("subscribe:order",t=>{e.join(`order:${t}`),console.log(`User ${r.userId} subscribed to order: ${t}`)}),e.on("unsubscribe:order",t=>{e.leave(`order:${t}`)}),e.on("subscribe:delivery",t=>{e.join(`delivery:${t}`)}),e.on("update:delivery-location",e=>{"DELIVERY"===r.role&&t.to(`delivery:${e.orderId}`).emit("delivery:location",{orderId:e.orderId,location:{lat:e.lat,lng:e.lng},timestamp:new Date().toISOString()})}),e.on("chat:typing",t=>{e.to(`chat:${t.chatId}`).emit("chat:typing",{userId:r.userId,name:r.name,isTyping:t.isTyping})}),e.on("chat:message",e=>{t.to(`chat:${e.chatId}`).emit("chat:message",{userId:r.userId,name:r.name,message:e.message,timestamp:new Date().toISOString()})}),e.on("disconnect",()=>{console.log(`User disconnected: ${r.userId}`);let t=(c.get(r.userId)||[]).filter(t=>t!==e.id);0===t.length?c.delete(r.userId):c.set(r.userId,t)})}),e.io=t,t}n()}catch(e){n(e)}})},66265:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>s,default:()=>a});var o=r(33339),i=e([o]);o=(i.then?(await i)():i)[0];let s={api:{bodyParser:!1}};function a(e,t){let r=t.socket;if(r?.server){let e=r.server;e.io||(console.log("Initializing Socket.io server..."),(0,o.DB)(e))}t.end()}n()}catch(e){n(e)}})},47153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=44587);module.exports=r})();